{"data":{"site":{"siteMetadata":{"title":"MaxFun","author":"maxfang"}},"markdownRemark":{"id":"b6aabfc0-dee3-51f2-adf5-e0cfd1329319","excerpt":"Base64 Encoding \næ˜¯ä¸€ç¨®åŸºæ–¼64å€‹å¯åˆ—å°å­—å…ƒä¾†è¡¨ç¤ºäºŒé€²ä½è³‡æ–™çš„è¡¨ç¤ºæ–¹æ³•ï¼Œæˆ‘å€‘å¯ä»¥é€šé base64 å­—ä¸²ä¾†è·Ÿ Graphql server åšæºé€šï¼Œä½† base64 ç·¨ç¢¼æ–‡ä»¶å°‡æ¯”åŸå§‹äºŒé€²è£½æ–‡ä»¶å¤§äº†å¤§ç´„33ï¼…ã€‚ FormData \næˆ‘è¦ºå¾—é€™æ˜¯ä¸€å€‹æ¯”è¼ƒå¥½çš„æ–¹æ³•ï¼Œé¦–å…ˆæˆ‘å€‘è¦å…ˆäº†è§£ä»€éº¼æ˜¯ FormDataâ€¦","html":"<p><img src=\"https://cdn-media-1.freecodecamp.org/images/1*xCKDdyMn2NKAiufB7jtTwg.png\" alt=\"javascript prototype\"></p>\n<center><small>apollo graphQL</small></center>\n<br>\næœ€è¿‘å·¥ä½œä¸Šé‡åˆ°é€™å•é¡Œï¼Œä¹ŸèŠ±äº†äº›æ™‚é–“ä¾†ç ”ç©¶ï¼Œåœ–ç‰‡ä¸Šå‚³ç›¸ä¿¡å¾ˆå¤šäººéƒ½æœ‰å¯¦ä½œéï¼Œä½†å¦‚æœæ˜¯è¦ç”¨ graphQL å¯¦ä½œåœ–ç‰‡ä¸Šå‚³å‘¢ï¼Œæœƒç¨å¾®éº»ç…©ä¸€é»ï¼Œä¸€èˆ¬ä¾†èªª web è¦å¯¦ä½œåœ–ç‰‡ä¸Šå‚³å…¶å¯¦ä¸¦ä¸é›£ï¼Œä»¥ä¸‹æœ‰å¹¾ç¨®æ–¹å¼å¯ä»¥åšé¸æ“‡ã€‚<br>\n<ul>\n<li>\n<p><strong>Base64 Encoding</strong>\næ˜¯ä¸€ç¨®åŸºæ–¼64å€‹å¯åˆ—å°å­—å…ƒä¾†è¡¨ç¤ºäºŒé€²ä½è³‡æ–™çš„è¡¨ç¤ºæ–¹æ³•ï¼Œæˆ‘å€‘å¯ä»¥é€šé base64 å­—ä¸²ä¾†è·Ÿ Graphql server åšæºé€šï¼Œä½† base64 ç·¨ç¢¼æ–‡ä»¶å°‡æ¯”åŸå§‹äºŒé€²è£½æ–‡ä»¶å¤§äº†å¤§ç´„33ï¼…ã€‚</p>\n</li>\n<li>\n<p><strong>FormData</strong>\næˆ‘è¦ºå¾—é€™æ˜¯ä¸€å€‹æ¯”è¼ƒå¥½çš„æ–¹æ³•ï¼Œé¦–å…ˆæˆ‘å€‘è¦å…ˆäº†è§£ä»€éº¼æ˜¯ FormData ï¼ŒFormData æ˜¯ Web API æä¾›çš„ä¸€ç¨®ç‰©ä»¶æ ¼å¼ï¼Œè¡¨å–®çš„ fields èˆ‡ valuesï¼Œå°æ‡‰åˆ°ç‰©ä»¶çš„ key/value ï¼Œåˆ©ç”¨åœ¨ Content-Type è¨­ç½® â€œmultipart/form-dataâ€ï¼Œå¯ä»¥å¾ˆè¼•æ˜“çš„åœ¨ç€è¦½å™¨ä¹‹é–“åšå‚³éã€‚</p>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\">  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>file<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>image-upoad<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">onchange</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>handleUpload()<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span></code></pre></div>\n<h2>In GraphQL</h2>\n<p>GraphQL ä¸»è¦å‚³éè³‡æ–™çš„æ–¹å¼æ˜¯æŠŠ query data ç¶“ç”± POST method æ”¾åœ¨ body è£¡é¢å‚³éçµ¦ Serverï¼ŒServer æœƒå†å»è§£æqueryè£¡é¢çš„è³‡æ–™ï¼Œè€Œ apollo-link-http å‰‡å¹«æˆ‘å€‘çµ±ä¸€ç«¯å£ä¸¦è™•ç†äº†è³‡æ–™ï¼Œä½†ä¸¦æœªæ”¯æ´ form-data æ ¼å¼ã€‚ğŸ¤¨\n\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/maxfun.io/static/1c6811bdb9af3277de77150a9e9e18fe/a621d/request-header.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 428px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 111.21495327102804%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsSAAALEgHS3X78AAAC+ElEQVQ4y5VVCXLbMBDT/5/YyLovyrqtyzq8AdaW0kzSptUMRzSHArEAlraK61WCIJQkSSSJY/E9V9Z1k3VZpa5rKctS2rYTPo/HQ8cx/+6x7ve7uK4L0EDSLJM4jqRSoEKuOCzH2Pf9/OAA/W4oIDeHYQhmnvhg6gCcoAQvq1KKopACLIdhkFvfy98eglr7RsBAXMeRKIzFtm3xAEp2aZoC8CphFD/nZI3fOQ7J81yaptU3K9q27cmQEzJ0XU+BMjDzUX4FVtw8z7PMkIXSLOsCfVeZpknXucb5fVk+Sj4APdcHw1AC3wOLUnzfx+ZZ/ufRkg9A3w/UYTUnzcQYo9pVZaVOT9P4I9hpSgA27sWBEanGJwNYZjI4nIsDbYtX+awgSWKVJEbEIo4okrppPptChw0+MLnBpkidvVxslF6cDKid6rjcT/0WaMf3YcgLcFMWYRipo8wdMxji5CRJNdy/3mw15p9KJrr99qbhJlBmEIOq0rIJavDbBlsf5f4UbGXINougCXVk6RfkkNGpqlrGcTxB9j+02pfWozYHGHPoOq5qGMMcusuOmeb5Czua+YndoSFnKbSK0A0hWu96LdQgOlzVFd5P0Py11naddhENY2tSpgYu83eWGbHIhlFha/Edx8nZASUyWKP0Hj38O6vjTf05jjXOLX7ITBEsR2zIhq3U9zd1mK4zh7wY9IK43XDgotHZ9ifYMA7SD70SsahN17Xa4Fy4AYj0/cDXXJZYb9oGo1VNXXQTA20Q/AX6A1EPdj1HtddOqZv6dMmAIePCMjvoxRYcx0kdZ5wKbcNJtaPGT6a7rjHoFikz0NzMkw7Bj6cFM7aa++qm87a5z0ok0qwalYRlWw9esFEoBg7GyVNLbuhunTJr4SDBeIFQFmrYD6NMYMxklDica+y03CSvG5uAADl69AYwDyAsj71LrVro6IGpsgEA1/vXDc79AQ4clSFKTlL+QSWw/uMPiOA8bMBHZD3CYQJTp3VbT0mYTzYB08D78x01/JV2wRfTCwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"javascript prototype\"\n        title=\"\"\n        src=\"/maxfun.io/static/1c6811bdb9af3277de77150a9e9e18fe/a621d/request-header.png\"\n        srcset=\"/maxfun.io/static/1c6811bdb9af3277de77150a9e9e18fe/b6e32/request-header.png 148w,\n/maxfun.io/static/1c6811bdb9af3277de77150a9e9e18fe/f64d6/request-header.png 295w,\n/maxfun.io/static/1c6811bdb9af3277de77150a9e9e18fe/a621d/request-header.png 428w\"\n        sizes=\"(max-width: 428px) 100vw, 428px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h2>- Clint(<a href=\"https://github.com/jaydenseric/apollo-upload-client\"><strong>apollo-upload-client</strong></a>) ğŸ‘»</h2>\n<p>ç€è¦½å™¨é è¨­çš„ Content-Type æ˜¯ application/jsonï¼Œè¦å‚³é FormData å‰‡éœ€è¦æ”¹æˆ multipart/form-dataï¼Œé€™æ™‚å°±éœ€è¦ <strong>apollo-upload-client</strong> ä¾†ä¿®æ”¹ç«¯å£å¹«æˆ‘å€‘å¯¦ç¾ã€‚\n<br>\n<br>\næˆ‘å€‘å¯ä»¥çœ‹åˆ° <strong>apollo-upload-client</strong> æ˜¯åŸºæ–¼ apollo-link å»å¯¦ç¾çš„ï¼Œä¸»è¦çš„æ˜¯åˆ¤æ–·è£¡é¢å¦‚æœæœ‰ files çš„è©±å°±æœƒé‡å° headers å»åšä¸€æ¬¡ä¿®æ”¹ï¼Œä¸¦æŠŠæ‹¿åˆ°çš„å…§å®¹ append åˆ° formDataã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">    <span class=\"token comment\">//....</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> clone<span class=\"token punctuation\">,</span> files <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">extractFiles</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> payload <span class=\"token operator\">=</span> <span class=\"token function\">serializeFetchParameter</span><span class=\"token punctuation\">(</span>clone<span class=\"token punctuation\">,</span> <span class=\"token string\">'Payload'</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>files<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// Automatically set by fetch when the body is a FormData instance.</span>\n      <span class=\"token keyword\">delete</span> options<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'content-type'</span><span class=\"token punctuation\">]</span>\n      <span class=\"token keyword\">const</span> form <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FormData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      form<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">'operations'</span><span class=\"token punctuation\">,</span> payload<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">//....</span></code></pre></div>\n<p>æœ€å¾Œå†ç¶“ç”±ç€è¦½å™¨åŸç”Ÿçš„ fetch æ–¹æ³•ï¼Œå‚³éè³‡æ–™çµ¦ Server</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">    <span class=\"token comment\">//....</span>\n    <span class=\"token function\">linkFetch</span><span class=\"token punctuation\">(</span>uri<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>response <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Forward the response on the context.</span>\n        operation<span class=\"token punctuation\">.</span><span class=\"token function\">setContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> response <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> response\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">//....</span></code></pre></div>\n<h2>- Server(<a href=\"https://github.com/jaydenseric/graphql-upload\">graphql-upload</a>) ğŸ‘»</h2>\n<p>åœ¨ GraphQL è£¡é¢éœ€è¦ç›¸å°æ‡‰çš„<a href=\"https://graphql.org/graphql-js/basic-types/\"><strong>å‹åˆ¥</strong></a>æ‰èƒ½æŠŠå…§å®¹é€£çµèµ·ä¾†ï¼Œä¾‹å¦‚: â€œHelloâ€ -> â€œStringâ€ï¼Œå¦‚æœå’ŒåŸºæœ¬å‹åˆ¥ä¸ç¬¦çš„å°±éœ€è¦è‡ªå®šç¾©ä¸€å€‹ upload å‹åˆ¥ï¼Œæˆ‘å€‘ä¾†çœ‹çœ‹æ€éº¼ç”¨ GraphQLScalarType å»è‡ªå®šç¾©ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">  <span class=\"token keyword\">const</span> typeDefs <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token string\">`\n    scalar Upload\n  `</span></span>\n  <span class=\"token keyword\">const</span> resolvers <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    Upload<span class=\"token punctuation\">:</span> GraphQLUpload\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> schema <span class=\"token operator\">=</span> <span class=\"token function\">makeExecutableSchema</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> typeDefs<span class=\"token punctuation\">,</span> resolvers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>  \n  <span class=\"token keyword\">const</span> GraphQLUpload <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">GraphQLScalarType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token string\">'Upload'</span><span class=\"token punctuation\">,</span>\n    description<span class=\"token punctuation\">:</span> <span class=\"token string\">'The `Upload` scalar type represents a file upload.'</span><span class=\"token punctuation\">,</span>\n    parseValue<span class=\"token punctuation\">:</span> value <span class=\"token operator\">=></span> value<span class=\"token punctuation\">,</span>\n    <span class=\"token function\">parseLiteral</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'â€˜Uploadâ€™ scalar literal unsupported.'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">serialize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'â€˜Uploadâ€™ scalar serialization unsupported.'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>å¾ˆä¸éŒ¯çš„æ˜¯ graphql-upload\b è£¡é¢å·²ç¶“å¹«æˆ‘å€‘å»å®šç¾©äº†é€™å€‹å‹åˆ¥äº†å”· ğŸ˜˜ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">  <span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> GraphQLUpload <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'graphql-upload'</span></code></pre></div>\n<p>ç•¶ express server æ¥æ”¶åˆ° clint ç«¯ POST data çš„æ™‚å€™ï¼Œæˆ‘å€‘éœ€è¦ body-parser ä¾†è§£æ URL ç·¨ç¢¼ï¼Œä½† body-parser ä¸æ”¯æ´ mutlipart bodiesï¼Œé€™æ™‚å°±æœƒæƒ³åˆ° express æ¡†æ¶çš„ <a href=\"https://github.com/mscdex/busboy\"><strong>busboy</strong></a> å»åšæª”æ¡ˆè™•ç†ï¼Œå¦‚æœä¸äº†è§£ä¹Ÿæ²’é—œä¿‚ï¼Œgraphql-upload è£¡é¢æä¾›äº†ä¸€å€‹ express middleware è®“æˆ‘å€‘å¯ä»¥å¾ˆå¿«åœ°å»ä½¿ç”¨ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">  <span class=\"token keyword\">import</span> express <span class=\"token keyword\">from</span> <span class=\"token string\">'express'</span>\n  <span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> graphqlUploadExpress <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'graphql-upload'</span>\n\n  <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">'/graphql'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">graphqlUploadExpress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> maxFileSize<span class=\"token punctuation\">:</span> <span class=\"token number\">10000000</span><span class=\"token punctuation\">,</span> maxFiles<span class=\"token punctuation\">:</span> <span class=\"token number\">10</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">graphqlHTTP</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> schema <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>ä¹‹å¾Œå°±å¯ä»¥åœ¨ schema resolve è£¡é¢å–å¾— image stream çš„è³‡æ–™å›‰ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">  <span class=\"token keyword\">async</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> image <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> filename<span class=\"token punctuation\">,</span> mimetype<span class=\"token punctuation\">,</span> createReadStream <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> image\n    <span class=\"token keyword\">const</span> stream <span class=\"token operator\">=</span> <span class=\"token function\">createReadStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>è³‡æ–™ä¾†æº:</strong><br>\n<small>\n<a href=\"https://www.freecodecamp.org/news/how-to-manage-file-uploads-in-graphql-mutations-using-apollo-graphene-b48ed6a6498c/\">- How to manage file uploads in GraphQL mutations using Apollo/Graphene</a>\n</small>\n<br>\n<small>\n<a href=\"https://zhuanlan.zhihu.com/p/50117878\">- Apollo graphQL å®ç°æ–‡ä»¶ä¸Šä¼ </a>\n</small>\n<br>\n<small>\n<a href=\"https://medium.com/cubemail88/node-js-express-js-body-parser-%E8%99%95%E7%90%86multipart-form-data%E7%9A%84%E8%A7%A3%E6%B1%BA%E6%96%B9%E6%A1%88-d89d2699b9f\">- [Node.js] express.js + body-parser è™•ç†multipart/form-dataçš„è§£æ±ºæ–¹æ¡ˆ</a>\n</small></p>","frontmatter":{"title":"Implement image uploads in Apollo GraphQL","date":"August 03, 2019","image":"https://cdn-media-1.freecodecamp.org/images/1*xCKDdyMn2NKAiufB7jtTwg.png"}}},"pageContext":{"slug":"/implement-upload-graphQL/","previous":{"fields":{"slug":"/javascript-design-patterns-part1/"},"frontmatter":{"title":"JavaScript Design Patterns -- Part 1"}},"next":null}}