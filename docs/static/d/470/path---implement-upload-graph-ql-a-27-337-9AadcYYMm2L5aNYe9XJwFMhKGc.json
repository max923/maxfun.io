{"data":{"site":{"siteMetadata":{"title":"MaxFun","author":"maxfang"}},"markdownRemark":{"id":"b6aabfc0-dee3-51f2-adf5-e0cfd1329319","excerpt":"Base64 Encoding \n是一種基於64個可列印字元來表示二進位資料的表示方法，我們可以通過 base64 字串來跟 Graphql server 做溝通，但 base64 編碼文件將比原始二進製文件大了大約33％。 FormData \n我覺得這是一個比較好的方法，首先我們要先了解什麼是 FormData…","html":"<p><img src=\"https://cdn-media-1.freecodecamp.org/images/1*xCKDdyMn2NKAiufB7jtTwg.png\" alt=\"javascript prototype\"></p>\n<center><small>apollo graphQL</small></center>\n<br>\n最近工作上遇到這問題，也花了些時間來研究，圖片上傳相信很多人都有實作過，但如果是要用 graphQL 實作圖片上傳呢，會稍微麻煩一點，一般來說 web 要實作圖片上傳其實並不難，以下有幾種方式可以做選擇。<br>\n<ul>\n<li>\n<p><strong>Base64 Encoding</strong>\n是一種基於64個可列印字元來表示二進位資料的表示方法，我們可以通過 base64 字串來跟 Graphql server 做溝通，但 base64 編碼文件將比原始二進製文件大了大約33％。</p>\n</li>\n<li>\n<p><strong>FormData</strong>\n我覺得這是一個比較好的方法，首先我們要先了解什麼是 FormData ，FormData 是 Web API 提供的一種物件格式，表單的 fields 與 values，對應到物件的 key/value ，利用在 Content-Type 設置 “multipart/form-data”，可以很輕易的在瀏覽器之間做傳遞。</p>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\">  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>file<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>image-upoad<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">onchange</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>handleUpload()<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span></code></pre></div>\n<h2>In GraphQL</h2>\n<p>GraphQL 主要傳遞資料的方式是把 query data 經由 POST method 放在 body 裡面傳遞給 Server，Server 會再去解析query裡面的資料，而 apollo-link-http 則幫我們統一端口並處理了資料，但並未支援 form-data 格式。🤨\n\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/maxfun.io/static/1c6811bdb9af3277de77150a9e9e18fe/a621d/request-header.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 428px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 111.21495327102804%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsSAAALEgHS3X78AAAC+ElEQVQ4y5VVCXLbMBDT/5/YyLovyrqtyzq8AdaW0kzSptUMRzSHArEAlraK61WCIJQkSSSJY/E9V9Z1k3VZpa5rKctS2rYTPo/HQ8cx/+6x7ve7uK4L0EDSLJM4jqRSoEKuOCzH2Pf9/OAA/W4oIDeHYQhmnvhg6gCcoAQvq1KKopACLIdhkFvfy98eglr7RsBAXMeRKIzFtm3xAEp2aZoC8CphFD/nZI3fOQ7J81yaptU3K9q27cmQEzJ0XU+BMjDzUX4FVtw8z7PMkIXSLOsCfVeZpknXucb5fVk+Sj4APdcHw1AC3wOLUnzfx+ZZ/ufRkg9A3w/UYTUnzcQYo9pVZaVOT9P4I9hpSgA27sWBEanGJwNYZjI4nIsDbYtX+awgSWKVJEbEIo4okrppPptChw0+MLnBpkidvVxslF6cDKid6rjcT/0WaMf3YcgLcFMWYRipo8wdMxji5CRJNdy/3mw15p9KJrr99qbhJlBmEIOq0rIJavDbBlsf5f4UbGXINougCXVk6RfkkNGpqlrGcTxB9j+02pfWozYHGHPoOq5qGMMcusuOmeb5Czua+YndoSFnKbSK0A0hWu96LdQgOlzVFd5P0Py11naddhENY2tSpgYu83eWGbHIhlFha/Edx8nZASUyWKP0Hj38O6vjTf05jjXOLX7ITBEsR2zIhq3U9zd1mK4zh7wY9IK43XDgotHZ9ifYMA7SD70SsahN17Xa4Fy4AYj0/cDXXJZYb9oGo1VNXXQTA20Q/AX6A1EPdj1HtddOqZv6dMmAIePCMjvoxRYcx0kdZ5wKbcNJtaPGT6a7rjHoFikz0NzMkw7Bj6cFM7aa++qm87a5z0ok0qwalYRlWw9esFEoBg7GyVNLbuhunTJr4SDBeIFQFmrYD6NMYMxklDica+y03CSvG5uAADl69AYwDyAsj71LrVro6IGpsgEA1/vXDc79AQ4clSFKTlL+QSWw/uMPiOA8bMBHZD3CYQJTp3VbT0mYTzYB08D78x01/JV2wRfTCwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"javascript prototype\"\n        title=\"\"\n        src=\"/maxfun.io/static/1c6811bdb9af3277de77150a9e9e18fe/a621d/request-header.png\"\n        srcset=\"/maxfun.io/static/1c6811bdb9af3277de77150a9e9e18fe/b6e32/request-header.png 148w,\n/maxfun.io/static/1c6811bdb9af3277de77150a9e9e18fe/f64d6/request-header.png 295w,\n/maxfun.io/static/1c6811bdb9af3277de77150a9e9e18fe/a621d/request-header.png 428w\"\n        sizes=\"(max-width: 428px) 100vw, 428px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h2>- Clint(<a href=\"https://github.com/jaydenseric/apollo-upload-client\"><strong>apollo-upload-client</strong></a>) 👻</h2>\n<p>瀏覽器預設的 Content-Type 是 application/json，要傳遞 FormData 則需要改成 multipart/form-data，這時就需要 <strong>apollo-upload-client</strong> 來修改端口幫我們實現。\n<br>\n<br>\n我們可以看到 <strong>apollo-upload-client</strong> 是基於 apollo-link 去實現的，主要的是判斷裡面如果有 files 的話就會針對 headers 去做一次修改，並把拿到的內容 append 到 formData。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">    <span class=\"token comment\">//....</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> clone<span class=\"token punctuation\">,</span> files <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">extractFiles</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> payload <span class=\"token operator\">=</span> <span class=\"token function\">serializeFetchParameter</span><span class=\"token punctuation\">(</span>clone<span class=\"token punctuation\">,</span> <span class=\"token string\">'Payload'</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>files<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// Automatically set by fetch when the body is a FormData instance.</span>\n      <span class=\"token keyword\">delete</span> options<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'content-type'</span><span class=\"token punctuation\">]</span>\n      <span class=\"token keyword\">const</span> form <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FormData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      form<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">'operations'</span><span class=\"token punctuation\">,</span> payload<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">//....</span></code></pre></div>\n<p>最後再經由瀏覽器原生的 fetch 方法，傳遞資料給 Server</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">    <span class=\"token comment\">//....</span>\n    <span class=\"token function\">linkFetch</span><span class=\"token punctuation\">(</span>uri<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>response <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Forward the response on the context.</span>\n        operation<span class=\"token punctuation\">.</span><span class=\"token function\">setContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> response <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> response\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">//....</span></code></pre></div>\n<h2>- Server(<a href=\"https://github.com/jaydenseric/graphql-upload\">graphql-upload</a>) 👻</h2>\n<p>在 GraphQL 裡面需要相對應的<a href=\"https://graphql.org/graphql-js/basic-types/\"><strong>型別</strong></a>才能把內容連結起來，例如: “Hello” -> “String”，如果和基本型別不符的就需要自定義一個 upload 型別，我們來看看怎麼用 GraphQLScalarType 去自定義。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">  <span class=\"token keyword\">const</span> typeDefs <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token string\">`\n    scalar Upload\n  `</span></span>\n  <span class=\"token keyword\">const</span> resolvers <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    Upload<span class=\"token punctuation\">:</span> GraphQLUpload\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> schema <span class=\"token operator\">=</span> <span class=\"token function\">makeExecutableSchema</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> typeDefs<span class=\"token punctuation\">,</span> resolvers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>  \n  <span class=\"token keyword\">const</span> GraphQLUpload <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">GraphQLScalarType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token string\">'Upload'</span><span class=\"token punctuation\">,</span>\n    description<span class=\"token punctuation\">:</span> <span class=\"token string\">'The `Upload` scalar type represents a file upload.'</span><span class=\"token punctuation\">,</span>\n    parseValue<span class=\"token punctuation\">:</span> value <span class=\"token operator\">=></span> value<span class=\"token punctuation\">,</span>\n    <span class=\"token function\">parseLiteral</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'‘Upload’ scalar literal unsupported.'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">serialize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'‘Upload’ scalar serialization unsupported.'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>很不錯的是 graphql-upload\b 裡面已經幫我們去定義了這個型別了唷 😘。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">  <span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> GraphQLUpload <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'graphql-upload'</span></code></pre></div>\n<p>當 express server 接收到 clint 端 POST data 的時候，我們需要 body-parser 來解析 URL 編碼，但 body-parser 不支援 mutlipart bodies，這時就會想到 express 框架的 <a href=\"https://github.com/mscdex/busboy\"><strong>busboy</strong></a> 去做檔案處理，如果不了解也沒關係，graphql-upload 裡面提供了一個 express middleware 讓我們可以很快地去使用。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">  <span class=\"token keyword\">import</span> express <span class=\"token keyword\">from</span> <span class=\"token string\">'express'</span>\n  <span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> graphqlUploadExpress <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'graphql-upload'</span>\n\n  <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">'/graphql'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">graphqlUploadExpress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> maxFileSize<span class=\"token punctuation\">:</span> <span class=\"token number\">10000000</span><span class=\"token punctuation\">,</span> maxFiles<span class=\"token punctuation\">:</span> <span class=\"token number\">10</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">graphqlHTTP</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> schema <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>之後就可以在 schema resolve 裡面取得 image stream 的資料囉。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">  <span class=\"token keyword\">async</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> image <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> filename<span class=\"token punctuation\">,</span> mimetype<span class=\"token punctuation\">,</span> createReadStream <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> image\n    <span class=\"token keyword\">const</span> stream <span class=\"token operator\">=</span> <span class=\"token function\">createReadStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>資料來源:</strong><br>\n<small>\n<a href=\"https://www.freecodecamp.org/news/how-to-manage-file-uploads-in-graphql-mutations-using-apollo-graphene-b48ed6a6498c/\">- How to manage file uploads in GraphQL mutations using Apollo/Graphene</a>\n</small>\n<br>\n<small>\n<a href=\"https://zhuanlan.zhihu.com/p/50117878\">- Apollo graphQL 实现文件上传</a>\n</small>\n<br>\n<small>\n<a href=\"https://medium.com/cubemail88/node-js-express-js-body-parser-%E8%99%95%E7%90%86multipart-form-data%E7%9A%84%E8%A7%A3%E6%B1%BA%E6%96%B9%E6%A1%88-d89d2699b9f\">- [Node.js] express.js + body-parser 處理multipart/form-data的解決方案</a>\n</small></p>","frontmatter":{"title":"Implement image uploads in Apollo GraphQL","date":"August 03, 2019","image":"https://cdn-media-1.freecodecamp.org/images/1*xCKDdyMn2NKAiufB7jtTwg.png"}}},"pageContext":{"slug":"/implement-upload-graphQL/","previous":{"fields":{"slug":"/javascript-design-patterns-part1/"},"frontmatter":{"title":"JavaScript Design Patterns -- Part 1"}},"next":null}}